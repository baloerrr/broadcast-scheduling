<%- include('partials/header') -%>

<div class="container p-4 d-flex flex-column align-items-center gap-4 justify-content-center min-vh-100">
  <div class="card border col-md-12 mt-4">
    <div class="card-header">
      <h5 class="card-title">Your Emails</h5>
    </div>
    <div class="card-body" id="emailsContainer">
      <!-- Emails will be inserted here by JavaScript -->
    </div>
  </div>

  <div class="card border-none">
    <div class="card-body d-flex gap-3 justify-content-center align-items-center">
      <a href="/send-email" class="btn btn-success">Send Email</a>
      <a href="/logout" class="btn btn-danger">Logout</a>
    </div>

    <% if (!user.appPassword) { %>
    <script>
      window.location.href = "/input-app-password";
    </script>
    <% } %> 
    
    <% if(!user.id) { %>
    <script>
      window.location.href = "/login";
    </script>
    <% } %>
  </div>
</div>

<script>
  async function sendAuthenticatedRequest(url, method = 'GET', body = null) {
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: body
    });

    if (!response.ok) {
      throw new Error(`Failed to fetch: ${response.statusText}`);
    }

    const data = await response.json();
    return data;
  }

  async function fetchEmails() {
    try {
      const emails = await sendAuthenticatedRequest("/api/emails?userId=<%= user.id %>");
      console.log('Fetched Emails:', emails);
      displayEmails(emails);
    } catch (error) {
      console.error('Error fetching emails:', error);
    }
  }

  function displayEmails(emails) {
    if (!Array.isArray(emails)) {
      console.error('Invalid emails format:', emails);
      return;
    }

    const container = document.getElementById("emailsContainer");
    container.innerHTML = ""; // Clear existing content

    emails.forEach(email => {
      const emailCard = document.createElement("div");
      emailCard.classList.add("card", "mb-3");
      emailCard.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">${email.subject}</h5>
          <p class="card-text">${email.content}</p>
          <p class="card-text"><small class="text-muted">To: ${email.to}</small></p>
          <a href="/edit-email/${email.id}" class="btn btn-primary">Edit</a>
          <button class="btn btn-danger ms-2" onclick="deleteEmail(${email.id})">Delete</button>
        </div>
      `;
      container.appendChild(emailCard);
    });
  }

  async function deleteEmail(emailId) {
    if (confirm('Are you sure you want to delete this email?')) {
      try {
        await sendAuthenticatedRequest(`/api/emails/${emailId}`, 'DELETE');
        alert('Email deleted successfully');
        fetchEmails(); // Refresh the list of emails
      } catch (error) {
        console.error('Error deleting email:', error);
        alert('Failed to delete email');
      }
    }
  }

  fetchEmails();
</script>

<%- include('partials/footer') -%>
